version: '2'
services:
    rethinkdb-container:
        #restart: always
        image: rethinkdb
        #image: mterron/rethinkdb
        hostname: rethinkdb
        volumes:
            - "/isard/database:/data"
        expose:
            - "28015"
        networks:
            main:
                aliases:
                - rethinkdb

    isard-hypervisor:
        #restart: always
        image: isard/hypervisor
        build:
            context: dockers/hypervisor
        links:
            - "rethinkdb-container"
        hostname: isard-hypervisor
        ports:
            - "80:80"
            - "5900-5930:5900-5930"
            - "55900-55930:55900-55930"
        expose:
            - "22"
        privileged: true
        volumes:
            - "sshkeys:/root/.ssh"
            - "/isard:/isard"
            - "/isard/builder:/root/.cache/virt-builder"
            - "/etc/hostname:/hostname"
            - "viewerkeys:/etc/pki/libvirt-spice"
        networks:
            main:
                aliases:
                - isard-hypervisor
        command: /usr/bin/supervisord -c /etc/supervisord.conf
        
    isard-webapp:
        #restart: always
        image: isard/webapp
        build:
            context: dockers/webapp
        links:
            - "rethinkdb-container"
        hostname: isard-webapp
        volumes:
            - "sshkeys:/root/.ssh"
            - "viewerkeys:/isard/install/viewer-certs"
        expose:
            - "5000"
        environment:
            PYTHONUNBUFFERED: 0
        extra_hosts:
            - "isard-engine:127.0.0.1"
        networks:
            main:
                aliases:
                - isard-webapp
        command: bash -c '/init.sh'


    isard-nginx:
        #restart: always
        image: isard/nginx
        build:
            context: dockers/nginx        
        ports:
            - "443:443"
        volumes:
            - "./dockers/nginx/:/etc/nginx/external"
        hostname: isard-nginx
        links:
            - "isard-webapp:isard-webapp"
        networks:
            main:
                aliases:
                - isard-nginx

networks:
    main:
volumes:
    sshkeys:
    viewerkeys:
